<div id="content" class="forum_list">
<div class="pageWidth">
<div class="pageContent">
<div class="mainContainer">
<div class="mainContent">
<div id="htfContentPage">
<article>
<div class="contributeEdit" style="float: right; width: 450px; max-width: 100%;">&nbsp;</div>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: medium;"><strong>Preventing SSH Dictionary Attacks With DenyHosts</strong></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Version 1.0</span><br /><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Author: Falko Timme</span><br /><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Last edited: 02/07/2006<br />From:&nbsp;https://www.howtoforge.com/preventing_ssh_dictionary_attacks_with_denyhosts<br /></span><span id="ezoic-pub-ad-placeholder-121" class="ezoic-adpicker-ad"></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">In this HowTo I will show how to install and configure DenyHosts. DenyHosts is a tool that observes login attempts to SSH, and if it finds failed login attempts again and again from the same IP address, DenyHosts blocks further login attempts from that IP address by putting it into <span style="font-family: 'Courier New', Courier, mono;"><em>/etc/hosts.deny</em></span>. DenyHosts can be run by cron or as a daemon. In this tutorial I will run DenyHosts as a daemon.</span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">From the <a href="http://denyhosts.sourceforge.net/" target="_blank" rel="noopener">DenyHosts web site</a>:</span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;"><em>"DenyHosts is a script intended to be run by Linux system administrators to help thwart ssh server attacks.</em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;"><em>If you've ever looked at your ssh log (/var/log/secure on Redhat, /var/log/auth.log on Mandrake, etc...) you may be alarmed to see how many hackers attempted to gain access to your server. Hopefully, none of them were successful (but then again, how would you know?). Wouldn't it be better to automatically prevent that attacker from continuing to gain entry into your system? </em></span><span id="ezoic-pub-ad-placeholder-130" class="ezoic-adpicker-ad"></span></p>
<div id="howtoforge_com-link-h-large-1" class="ezo_link_unit_a">&nbsp;</div>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;"><em>DenyHosts attempts to address the above... "</em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">This tutorial is based on a Debian Sarge system, however, it should apply to other distributions with almost no modifications.</span></p>
<div style="width: 336px; float: left; margin: 10px 15px 10px 0px; background-color: white;">&nbsp;</div>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">I want to say first that this is not the only way of setting up such a system. There are many ways of achieving this goal but this is the way I take. I do not issue any guarantee that this will work for you!</span></p>
<h4><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: medium;">1 Installation</span></h4>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">DenyHosts is written in Python, therefore we must install Python and also the Python development files first:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">apt-get install python python2.3-dev python2.3</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Then we download and install DenyHosts like this:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">cd /tmp<br />wget http://mesh.dl.sourceforge.net/sourceforge/denyhosts/DenyHosts-2.0.tar.gz<br />tar xvfz DenyHosts-2.0.tar.gz<br />cd DenyHosts-2.0<br />python setup.py install</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">This installs DenyHosts to <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts</em></span>.</span><span id="ezoic-pub-ad-placeholder-110" class="ezoic-adpicker-ad"></span><span id="div-gpt-ad-howtoforge_com-box-4-0" class="ezoic-ad ezoic-adl" style="position: relative; z-index: 0; display: inline-block; width: 100%; max-width: 1200px; margin-left: auto !important; margin-right: auto !important; min-height: 400px; min-width: 580px;"></span></p>
<h4><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: medium;">2 Configuration</span></h4>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Now we have to create the DenyHosts configuration file <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts/denyhosts.cfg</em></span>. We can use the sample configuration file <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts/denyhosts.cfg-dist</em></span> for this:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">cd /usr/share/denyhosts<br />cp denyhosts.cfg-dist denyhosts.cfg</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Then we must edit</span><span style="font-family: 'Courier New', Courier, mono; font-size: small;"><em> denyhosts.cfg</em><span style="font-family: Verdana, Arial, Helvetica, sans-serif;"> with our favourite editor such as</span><em> vi</em><span style="font-family: Verdana, Arial, Helvetica, sans-serif;">, for example. Mine looks like this:</span></span></p>
<table border="1" width="90%" cellspacing="0" cellpadding="2" align="center" bgcolor="#cccccc">
<tbody>
<tr>
<td>
<pre><code spellcheck="false">       ############ THESE SETTINGS ARE REQUIRED ############<br /><br />########################################################################<br />#<br /># SECURE_LOG: the log file that contains sshd logging info<br /># if you are not sure, grep "sshd:" /var/log/*<br />#<br /># The file to process can be overridden with the --file command line<br /># argument<br />#<br /># Redhat or Fedora Core:<br />#SECURE_LOG = /var/log/secure<br />#<br /># Mandrake, FreeBSD or OpenBSD:<br />SECURE_LOG = /var/log/auth.log<br />#<br /># SuSE:<br />#SECURE_LOG = /var/log/messages<br />#<br />########################################################################<br /><br />########################################################################<br /># HOSTS_DENY: the file which contains restricted host access information<br />#<br /># Most operating systems:<br />HOSTS_DENY = /etc/hosts.deny<br />#<br /># Some BSD (FreeBSD) Unixes:<br />#HOSTS_DENY = /etc/hosts.allow<br />#<br /># Another possibility (also see the next option):<br />#HOSTS_DENY = /etc/hosts.evil<br />#######################################################################<br /><br /><br />########################################################################<br /># PURGE_DENY: removed HOSTS_DENY entries that are older than this time<br />#             when DenyHosts is invoked with the --purge flag<br />#<br />#      format is: i[dhwmy]<br />#      Where 'i' is an integer (eg. 7)<br />#            'm' = minutes<br />#            'h' = hours<br />#            'd' = days<br />#            'w' = weeks<br />#            'y' = years<br />#<br /># never purge:<br />PURGE_DENY =<br />#<br /># purge entries older than 1 week<br />#PURGE_DENY = 1w<br />#<br /># purge entries older than 5 days<br />#PURGE_DENY = 5d<br />#######################################################################<br /><br /><br />#######################################################################<br /># BLOCK_SERVICE: the service name that should be blocked in HOSTS_DENY<br />#<br /># man 5 hosts_access for details<br />#<br /># eg.   sshd: 127.0.0.1  # will block sshd logins from 127.0.0.1<br />#<br /># To block all services for the offending host:<br />#BLOCK_SERVICE = ALL<br /># To block only sshd:<br />BLOCK_SERVICE  = sshd<br /># To only record the offending host and nothing else (if using<br /># an auxilary file to list the hosts).  Refer to:<br /># http://denyhosts.sourceforge.net/faq.html#aux<br />#BLOCK_SERVICE =<br />#<br />#######################################################################<br /><br /><br />#######################################################################<br />#<br /># DENY_THRESHOLD_INVALID: block each host after the number of failed login<br /># attempts has exceeded this value.  This value applies to invalid<br /># user login attempts (eg. non-existent user accounts)<br />#<br />DENY_THRESHOLD_INVALID = 5<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># DENY_THRESHOLD_VALID: block each host after the number of failed<br /># login attempts has exceeded this value.  This value applies to valid<br /># user login attempts (eg. user accounts that exist in /etc/passwd) except<br /># for the "root" user<br />#<br />DENY_THRESHOLD_VALID = 10<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># DENY_THRESHOLD_ROOT: block each host after the number of failed<br /># login attempts has exceeded this value.  This value applies to<br /># "root" user login attempts only.<br />#<br />DENY_THRESHOLD_ROOT = 5<br />#<br />#######################################################################<br /><br /><br />#######################################################################<br />#<br /># WORK_DIR: the path that DenyHosts will use for writing data to<br /># (it will be created if it does not already exist).<br />#<br /># Note: it is recommended that you use an absolute pathname<br /># for this value (eg. /home/foo/denyhosts/data)<br />#<br />WORK_DIR = /usr/share/denyhosts/data<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># SUSPICIOUS_LOGIN_REPORT_ALLOWED_HOSTS<br />#<br /># SUSPICIOUS_LOGIN_REPORT_ALLOWED_HOSTS=YES|NO<br /># If set to YES, if a suspicious login attempt results from an allowed-host<br /># then it is considered suspicious.  If this is NO, then suspicious logins<br /># from allowed-hosts will not be reported.  All suspicious logins from<br /># ip addresses that are not in allowed-hosts will always be reported.<br />#<br />SUSPICIOUS_LOGIN_REPORT_ALLOWED_HOSTS=YES<br />######################################################################<br /><br />######################################################################<br />#<br /># HOSTNAME_LOOKUP<br />#<br /># HOSTNAME_LOOKUP=YES|NO<br /># If set to YES, for each IP address that is reported by Denyhosts,<br /># the corresponding hostname will be looked up and reported as well<br /># (if available).<br />#<br />HOSTNAME_LOOKUP=YES<br />#<br />######################################################################<br /><br /><br />######################################################################<br />#<br /># LOCK_FILE<br />#<br /># LOCK_FILE=/path/denyhosts<br /># If this file exists when DenyHosts is run, then DenyHosts will exit<br /># immediately.  Otherwise, this file will be created upon invocation<br /># and deleted upon exit.  This ensures that only one instance is<br /># running at a time.<br />#<br /># Redhat/Fedora:<br />#LOCK_FILE = /var/lock/subsys/denyhosts<br />#<br /># Debian<br />LOCK_FILE = /var/run/denyhosts.pid<br />#<br /># Misc<br />#LOCK_FILE = /tmp/denyhosts.lock<br />#<br />######################################################################<br /><br /><br />       ############ THESE SETTINGS ARE OPTIONAL ############<br /><br /><br />#######################################################################<br />#<br /># ADMIN_EMAIL: if you would like to receive emails regarding newly<br /># restricted hosts and suspicious logins, set this address to<br /># match your email address.  If you do not want to receive these reports<br /># leave this field blank (or run with the --noemail option)<br />#<br />ADMIN_EMAIL =<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br />SMTP_HOST = localhost<br />SMTP_PORT = 25<br />SMTP_FROM = DenyHosts &lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="214f4e434e4558614d4e42404d494e5255">[email&nbsp;protected]</a>&gt;<br />SMTP_SUBJECT = DenyHosts Report<br />#SMTP_USERNAME=foo<br />#SMTP_PASSWORD=bar<br />#<br />#######################################################################<br /><br />######################################################################<br />#<br /># ALLOWED_HOSTS_HOSTNAME_LOOKUP<br />#<br /># ALLOWED_HOSTS_HOSTNAME_LOOKUP=YES|NO<br /># If set to YES, for each entry in the WORK_DIR/allowed-hosts file,<br /># the hostname will be looked up.  If your versions of tcp_wrappers<br /># and sshd sometimes log hostnames in addition to ip addresses<br /># then you may wish to specify this option.<br />#<br />#ALLOWED_HOSTS_HOSTNAME_LOOKUP=NO<br />#<br />######################################################################<br /><br />######################################################################<br />#<br /># AGE_RESET_VALID: Specifies the period of time between failed login<br /># attempts that, when exceeded will result in the failed count for<br /># this host to be reset to 0.  This value applies to login attempts<br /># to all valid users (those within /etc/passwd) with the<br /># exception of root.  If not defined, this count will never<br /># be reset.<br />#<br /># See the comments in the PURGE_DENY section (above)<br /># for details on specifying this value or for complete details<br /># refer to:  http://denyhosts.sourceforge.net/faq.html#timespec<br />#<br />AGE_RESET_VALID=5d<br />#<br />######################################################################<br /><br />######################################################################<br />#<br /># AGE_RESET_ROOT: Specifies the period of time between failed login<br /># attempts that, when exceeded will result in the failed count for<br /># this host to be reset to 0.  This value applies to all login<br /># attempts to the "root" user account.  If not defined,<br /># this count will never be reset.<br />#<br /># See the comments in the PURGE_DENY section (above)<br /># for details on specifying this value or for complete details<br /># refer to:  http://denyhosts.sourceforge.net/faq.html#timespec<br />#<br />AGE_RESET_ROOT=25d<br />#<br />######################################################################<br /><br />######################################################################<br />#<br /># AGE_RESET_INVALID: Specifies the period of time between failed login<br /># attempts that, when exceeded will result in the failed count for<br /># this host to be reset to 0.  This value applies to login attempts<br /># made to any invalid username (those that do not appear<br /># in /etc/passwd).  If not defined, count will never be reset.<br />#<br /># See the comments in the PURGE_DENY section (above)<br /># for details on specifying this value or for complete details<br /># refer to:  http://denyhosts.sourceforge.net/faq.html#timespec<br />#<br />AGE_RESET_INVALID=10d<br />#<br />######################################################################<br /><br />######################################################################<br />#<br /># PLUGIN_DENY: If set, this value should point to an executable<br /># program that will be invoked when a host is added to the<br /># HOSTS_DENY file.  This executable will be passed the host<br /># that will be added as it's only argument.<br />#<br />#PLUGIN_DENY=/usr/bin/true<br />#<br />######################################################################<br /><br /><br />######################################################################<br />#<br /># PLUGIN_PURGE: If set, this value should point to an executable<br /># program that will be invoked when a host is removed from the<br /># HOSTS_DENY file.  This executable will be passed the host<br /># that is to be purged as it's only argument.<br />#<br />#PLUGIN_PURGE=/usr/bin/true<br />#<br />######################################################################<br /><br />######################################################################<br />#<br /># USERDEF_FAILED_ENTRY_REGEX: if set, this value should contain<br /># a regular expression that can be used to identify additional<br /># hackers for your particular ssh configuration.  This functionality<br /># extends the built-in regular expressions that DenyHosts uses.<br /># This parameter can be specified multiple times.<br /># See this faq entry for more details:<br />#    http://denyhosts.sf.net/faq.html#userdef_regex<br />#<br />#USERDEF_FAILED_ENTRY_REGEX=<br />#<br />#<br />######################################################################<br /><br /><br /><br /><br />   ######### THESE SETTINGS ARE SPECIFIC TO DAEMON MODE  ##########<br /><br /><br /><br />#######################################################################<br />#<br /># DAEMON_LOG: when DenyHosts is run in daemon mode (--daemon flag)<br /># this is the logfile that DenyHosts uses to report it's status.<br /># To disable logging, leave blank.  (default is: /var/log/denyhosts)<br />#<br />DAEMON_LOG = /var/log/denyhosts<br />#<br /># disable logging:<br />#DAEMON_LOG =<br />#<br />######################################################################<br /><br />#######################################################################<br />#<br /># DAEMON_LOG_TIME_FORMAT: when DenyHosts is run in daemon mode<br /># (--daemon flag) this specifies the timestamp format of<br /># the DAEMON_LOG messages (default is the ISO8061 format:<br /># ie. 2005-07-22 10:38:01,745)<br />#<br /># for possible values for this parameter refer to: man strftime<br />#<br /># Jan 1 13:05:59<br />#DAEMON_LOG_TIME_FORMAT = %b %d %H:%M:%S<br />#<br /># Jan 1 01:05:59<br />#DAEMON_LOG_TIME_FORMAT = %b %d %I:%M:%S<br />#<br />######################################################################<br /><br />#######################################################################<br />#<br /># DAEMON_LOG_MESSAGE_FORMAT: when DenyHosts is run in daemon mode<br /># (--daemon flag) this specifies the message format of each logged<br /># entry.  By default the following format is used:<br />#<br /># %(asctime)s - %(name)-12s: %(levelname)-8s %(message)s<br />#<br /># Where the "%(asctime)s" portion is expanded to the format<br /># defined by DAEMON_LOG_TIME_FORMAT<br />#<br /># This string is passed to python's logging.Formatter contstuctor.<br /># For details on the possible format types please refer to:<br /># http://docs.python.org/lib/node357.html<br />#<br /># This is the default:<br />#DAEMON_LOG_MESSAGE_FORMAT = %(asctime)s - %(name)-12s: %(levelname)-8s %(message)s<br />#<br />#<br />######################################################################<br /><br /><br />#######################################################################<br />#<br /># DAEMON_SLEEP: when DenyHosts is run in daemon mode (--daemon flag)<br /># this is the amount of time DenyHosts will sleep between polling<br /># the SECURE_LOG.  See the comments in the PURGE_DENY section (above)<br /># for details on specifying this value or for complete details<br /># refer to:    http://denyhosts.sourceforge.net/faq.html#timespec<br />#<br />#<br />DAEMON_SLEEP = 30s<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># DAEMON_PURGE: How often should DenyHosts, when run in daemon mode,<br /># run the purge mechanism to expire old entries in HOSTS_DENY<br /># This has no effect if PURGE_DENY is blank.<br />#<br />DAEMON_PURGE = 1h<br />#<br />#######################################################################<br /><br /><br />   #########   THESE SETTINGS ARE SPECIFIC TO     ##########<br />   #########       DAEMON SYNCHRONIZATION         ##########<br /><br /><br />#######################################################################<br />#<br /># Synchronization mode allows the DenyHosts daemon the ability<br /># to periodically send and receive denied host data such that<br /># DenyHosts daemons worldwide can automatically inform one<br /># another regarding banned hosts.   This mode is disabled by<br /># default, you must uncomment SYNC_SERVER to enable this mode.<br />#<br /># for more information, please refer to:<br />#        http:/denyhosts.sourceforge.net/faq.html#sync<br />#<br />#######################################################################<br /><br /><br />#######################################################################<br />#<br /># SYNC_SERVER: The central server that communicates with DenyHost<br /># daemons.  Currently, denyhosts.net is the only available server<br /># however, in the future, it may be possible for organizations to<br /># install their own server for internal network synchronization<br />#<br /># To disable synchronization (the default), do nothing.<br />#<br /># To enable synchronization, you must uncomment the following line:<br />#SYNC_SERVER = http://xmlrpc.denyhosts.net:9911<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># SYNC_INTERVAL: the interval of time to perform synchronizations if<br /># SYNC_SERVER has been uncommented.  The default is 1 hour.<br />#<br />#SYNC_INTERVAL = 1h<br />#<br />#######################################################################<br /><br /><br />#######################################################################<br />#<br /># SYNC_UPLOAD: allow your DenyHosts daemon to transmit hosts that have<br /># been denied?  This option only applies if SYNC_SERVER has<br /># been uncommented.<br />#<br />#SYNC_UPLOAD = no<br />#<br /># the default:<br />#SYNC_UPLOAD = yes<br />#<br />#######################################################################<br /><br /><br />#######################################################################<br />#<br /># SYNC_DOWNLOAD: allow your DenyHosts daemon to receive hosts that have<br /># been denied by others?  This option only applies if SYNC_SERVER has<br /># been uncommented.<br />#<br />#SYNC_DOWNLOAD = no<br />#<br /># the default:<br />#SYNC_DOWNLOAD = yes<br />#<br />#######################################################################<br /><br />#######################################################################<br />#<br /># SYNC_DOWNLOAD_THRESHOLD: If SYNC_DOWNLOAD is enabled this paramter<br /># filters the returned hosts to those that have been blocked this many<br /># times by others.  That is, if set to 1, then if a single DenyHosts<br /># server has denied an ip address then you will receive the denied host.<br />#<br />#SYNC_DOWNLOAD_THRESHOLD = 10<br />#<br /># the default:<br />#SYNC_DOWNLOAD_THRESHOLD = 3<br />#<br />#######################################################################</code></pre>
</td>
</tr>
</tbody>
</table>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Make sure you set <span style="font-family: 'Courier New', Courier, mono;"><em>SECURE_LOG</em></span> and <span style="font-family: 'Courier New', Courier, mono;"><em>LOCK_FILE</em></span> to the correct values for your distribution! For Debian, these are:</span><span id="ezoic-pub-ad-placeholder-111" class="ezoic-adpicker-ad"></span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">SECURE_LOG = /var/log/auth.log<br />LOCK_FILE = /var/run/denyhosts.pid</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">As we want to run DenyHosts as a daemon, we need the daemon control script <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts/daemon-control</em></span>. Again, we can use the sample script <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts/daemon-control-dist</em></span> to create the needed file:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">cp daemon-control-dist daemon-control</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Edit <em><em><span style="font-family: 'Courier New', Courier, mono;">/usr/share/denyhosts/daemon-control</span></em></em> and make sure you set the correct values for</span><em> <span style="font-family: 'Courier New', Courier, mono; font-size: small;">DENYHOSTS_BIN</span></em><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">,</span><em> <span style="font-family: 'Courier New', Courier, mono; font-size: small;">DENYHOSTS_LOCK</span></em><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">, and</span><em> <span style="font-family: 'Courier New', Courier, mono; font-size: small;">DENYHOSTS_CFG</span></em><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">. For Debian, these are:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">DENYHOSTS_BIN = "/usr/bin/denyhosts.py"<br />DENYHOSTS_LOCK = "/var/run/denyhosts.pid"<br />DENYHOSTS_CFG = "/usr/share/denyhosts/denyhosts.cfg"</span></em></span><span id="ezoic-pub-ad-placeholder-112" class="ezoic-adpicker-ad"></span><span class="ezoic-ad large-leaderboard-2 adtester-container adtester-container-112 ezoic-ad-adaptive" style="background: 0 0 !important; display: flex !important; float: none; justify-content: space-between; min-height: 250px; min-width: 580px; text-align: center !important; width: 580px; margin: 15px !important auto !important 15px !important auto !important;" data-ez-name="howtoforge_com-large-leaderboard-2"><span style="font-size: smaller; display: block; text-align: center; width: inherit !important; position: absolute;">Advertisement</span><span id="div-gpt-ad-howtoforge_com-large-leaderboard-2-0" class="ezoic-ad" style="position: relative; z-index: 0; display: block !important; margin-left: auto !important; margin-right: auto !important;"></span><span id="div-gpt-ad-howtoforge_com-large-leaderboard-2-0_1" class="ezoic-ad" style="position: relative; z-index: 0; display: block !important; margin-left: auto !important; margin-right: auto !important;"></span></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">So my </span><em><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;"><em><em><span style="font-family: 'Courier New', Courier, mono;">/usr/share/denyhosts/daemon-control</span></em></em></span> </em><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">file looks like this:</span></p>
<table border="1" width="90%" cellspacing="0" cellpadding="2" align="center" bgcolor="#cccccc">
<tbody>
<tr>
<td>
<pre><code spellcheck="false">#!/usr/bin/env python<br /># denyhosts     Bring up/down the DenyHosts daemon<br />#<br /># chkconfig: 2345 98 02<br /># description: Activates/Deactivates the<br />#    DenyHosts daemon to block ssh attempts<br />#<br />###############################################<br /><br />###############################################<br />#### Edit these to suit your configuration ####<br />###############################################<br /><br />DENYHOSTS_BIN   = "/usr/bin/denyhosts.py"<br />DENYHOSTS_LOCK  = "/var/run/denyhosts.pid"<br />DENYHOSTS_CFG   = "/usr/share/denyhosts/denyhosts.cfg"<br /><br /><br />###############################################<br />####         Do not edit below             ####<br />###############################################<br /><br />import os, sys, signal, time<br /><br />STATE_NOT_RUNNING = -1<br />STATE_LOCK_EXISTS = -2<br /><br />def usage():<br />    print "Usage: %s {start [args...] | stop | restart [args...] | status | debug | condrestart [args...] }" % sys.argv[0]<br />    print<br />    print "For a list of valid 'args' refer to:"<br />    print "$ denyhosts.py --help"<br />    print<br />    sys.exit(0)<br /><br /><br />def getpid():<br />    try:<br />        fp = open(DENYHOSTS_LOCK, "r")<br />        pid = int(fp.readline().rstrip())<br />        fp.close()<br />    except Exception, e:<br />        return STATE_NOT_RUNNING<br /><br />    if os.access(os.path.join("/proc", str(pid)), os.F_OK):<br />        return pid<br />    else:<br />        return STATE_LOCK_EXISTS<br /><br /><br />def start(*args):<br />    cmd = "%s --daemon " % DENYHOSTS_BIN<br />    if args: cmd += ' '.join(args)<br /><br />    print "starting DenyHosts:   ", cmd<br /><br />    os.system(cmd)<br /><br /><br />def stop():<br />    pid = getpid()<br />    if pid &gt;= 0:<br />        os.kill(pid, signal.SIGTERM)<br />        print "sent DenyHosts SIGTERM"<br />    else:<br />        print "DenyHosts is not running"<br /><br />def debug():<br />    pid = getpid()<br />    if pid &gt;= 0:<br />        os.kill(pid, signal.SIGUSR1)<br />        print "sent DenyHosts SIGUSR1"<br />    else:<br />        print "DenyHosts is not running"<br /><br />def status():<br />    pid = getpid()<br />    if pid == STATE_LOCK_EXISTS:<br />        print "%s exists but DenyHosts is not running" % DENYHOSTS_LOCK<br />    elif pid == STATE_NOT_RUNNING:<br />        print "Denyhosts is not running"<br />    else:<br />        print "DenyHosts is running with pid = %d" % pid<br /><br /><br />def condrestart(*args):<br />    pid = getpid()<br />    if pid &gt;= 0:<br />        restart(*args)<br /><br /><br />def restart(*args):<br />    stop()<br />    time.sleep(1)<br />    start(*args)<br /><br /><br />if __name__ == '__main__':<br />    cases = {'start':       start,<br />             'stop':        stop,<br />             'debug':       debug,<br />             'status':      status,<br />             'condrestart': condrestart,<br />             'restart':     restart}<br /><br />    try:<br />        args = sys.argv[2:]<br />    except:<br />        args = []<br /><br />    try:<br />        option = sys.argv[1]<br /><br />        if option in ('start', 'restart', 'condrestart'):<br />            if '--config' not in args and '-c' not in args:<br />                args.append("--config=%s" % DENYHOSTS_CFG)<br /><br />        cmd = cases[option]<br />        apply(cmd, args)<br />    except:<br />        usage()<br /></code></pre>
</td>
</tr>
</tbody>
</table>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Next we have to make that file executable:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">chown root daemon-control<br />chmod 700 daemon-control</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Afterwards, we create the system bootup links for DenyHosts do that it is started automatically when the system is booted:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">cd /etc/init.d<br />ln -s /usr/share/denyhosts/daemon-control denyhosts<br />update-rc.d denyhosts defaults</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">Finally, we start DenyHosts:</span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">/etc/init.d/denyhosts start</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">DenyHosts logs to</span><span style="font-family: 'Courier New', Courier, mono; font-size: small;"><em> /var/log/denyhosts</em><span style="font-family: Verdana, Arial, Helvetica, sans-serif;">, if you are interested in the logs. The SSH daemon logs to</span><em> /var/log/auth.log</em><span style="font-family: Verdana, Arial, Helvetica, sans-serif;"> on Debian. You can watch both logs and try to log in with an invalid user or with a valid user and incorrect password, etc. via SSH and see what happens. After you have crossed the threshold of incorrect login attempts, the IP address from which you tried to connect should get listed in </span><em>/etc/hosts.deny</em><span style="font-family: Verdana, Arial, Helvetica, sans-serif;">, like this:</span></span></p>
<table border="1" width="90%" cellspacing="0" cellpadding="2" align="center" bgcolor="#cccccc">
<tbody>
<tr>
<td>
<pre><code spellcheck="false"># /etc/hosts.deny: list of hosts that are _not_ allowed to access the system.<br />#                  See the manual pages hosts_access(5), hosts_options(5)<br />#                  and /usr/doc/netbase/portmapper.txt.gz<br />#<br /># Example:    ALL: some.host.name, .some.domain<br />#             ALL EXCEPT in.fingerd: other.host.name, .other.domain<br />#<br /># If you're going to protect the portmapper use the name "portmap" for the<br /># daemon name. Remember that you can only use the keyword "ALL" and IP<br /># addresses (NOT host or domain names) for the portmapper. See portmap(8)<br /># and /usr/doc/portmap/portmapper.txt.gz for further information.<br />#<br /># The PARANOID wildcard matches any host whose name does not match its<br /># address.<br /><br /># You may wish to enable this to ensure any programs that don't<br /># validate looked up hostnames still leave understandable logs. In past<br /># versions of Debian this has been the default.<br /># ALL: PARANOID<br />sshd: 192.168.0.203</code></pre>
</td>
</tr>
</tbody>
</table>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">This means that the system with the IP address <span style="font-family: 'Courier New', Courier, mono;"><em>192.168.0.203</em></span> cannot connect anymore using SSH.</span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">You can specify if/when IP addresses are removed again from <span style="font-family: 'Courier New', Courier, mono;"><em>/etc/hosts.deny</em></span> - have a look at the <span style="font-family: 'Courier New', Courier, mono;"><em>PURGE_DENY</em></span> variable in <span style="font-family: 'Courier New', Courier, mono;"><em>/usr/share/denyhosts/denyhosts.cfg</em></span>. You must start DenyHosts with the <span style="font-family: 'Courier New', Courier, mono;"><em>--purge</em></span> option to make the <span style="font-family: 'Courier New', Courier, mono;"><em>PURGE_DENY</em></span> variable effective, like this:</span><span id="ezoic-pub-ad-placeholder-113" class="ezoic-adpicker-ad"></span></p>
<p><span style="font-family: 'Courier New', Courier, mono;"><em><span style="font-size: small;">/etc/init.d/denyhosts start --purge</span></em></span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">However, you can also remove IP addresses manually from there, and as soon as they have got removed, these IP addresses can try to log in again via SSH.</span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;"><strong>Links</strong></span></p>
<ul>
<li><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: small;">DenyHosts: <a href="http://denyhosts.sourceforge.net/" target="_blank" rel="noopener">http://denyhosts.sourceforge.net</a></span></li>
</ul>
</article>
<aside class="authorbox" style="margin-top: 20px;"><img src="/images/profile/falko-timme.jpg" alt="Falko Timme" />
<p><strong>About Falko Timme</strong></p>
<p>Falko Timme is an experienced Linux administrator and founder of Timme Hosting, a leading nginx business hosting company in Germany. He is one of the most active authors on HowtoForge since 2005 and one of the core developers of ISPConfig since 2000. He has also contributed to the O'Reilly book "Linux System Administration".</p>
</aside>
<div style="height: 30px; margin-top: 20px;">
<p style="text-align: right;"><img src="/images/pdficon_small.png" /> <a class="pdf-btn">view as pdf</a> | <img src="/images/print.gif" /> <a class="print-btn">print</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="subscriptionModal" class="modal">
<div class="modal-content"><span class="close">&times;</span>
<p>This feature is only available to subscribers. Get your subscription <a href="/subscription">here</a>.</p>
</div>
</div>
<div id="ezmobfooter" class="ezmob-footer ezoic-floating-bottom ezo_ad ezmob-footer-desktop"><center><span id="ezoic-pub-ad-placeholder-100"></span>
<div id="ezmobfooter" class="ezmob-footer ezoic-floating-bottom ezo_ad ezmob-footer-desktop"><center><span id="div-gpt-ad-howtoforge_com-medrectangle-2-0" class="ezoic-ad" style="position: relative; z-index: 0; display: inline-block; min-height: 90px; min-width: 728px;"></span></center><span class="ezmob-footer-close">x</span></div>
</center><span class="ezmob-footer-close">x</span></div>
<noscript><div style=display:none;><img src="//pixel.quantserve.com/pixel/p-31iz6hfFutd16.gif?labels=Domain.howtoforge_com,DomainId.178704" border=0 height=1 width=1 alt=Quantcast></div></noscript><noscript><img src="https://sb.scorecardresearch.com/p?c1=2&c2=20015427&cv=2.0&cj=1"></noscript>
